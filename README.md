Бот для торговли акциями на Московской Бирже с использованием Tinkoff Invest API на основе машинного обучения.

## Установка библиотек

```
pip install tinkoff-investments catboost
```

## Запуск

Cmd:
```
set TINKOFF_INVEST_API_TOKEN = ‹your_token>
set TINKOFF_INVEST_ACC-ID-1 = <your_account_id>
set TINKOFF_INVEST_APPNAME = <your_appname>
python ./tradeBot.py
```

Bash:
```
export TINKOFF_INVEST_API_TOKEN = <your_token>
export TINKOFF_INVEST_ACC-ID-1 = <your_account_id>
export TINKOFF_INVEST_APPNAME = <your_appname>
python3 ./tradeBot.py
```

Python:
```
import os
import tradeBot

os.environ["TINKOFF_INVEST_API_TOKEN"] = <your_token>
os.environ["TINKOFF_INVEST_ACC-ID-1"] = <your_account_id>
os.environ["TINKOFF_INVEST_APPNAME"] = <your_appname>

bot = tradeBot.TradeBot()
```

### Остановка скрипта

-Ctrl-C или наличие файла "stopBot.flag" в рабочей директории бота

## Описание алгоритма

Для торговли используются акции Московской Биржи.
Предварительно осуществляется обучение и проверка модели на исторических данных по дневным свечам.

1. В начале каждой торговой сессии скачиваются текущие свечи для всех используемых акций и обновляются вчерашние.
2. Для обновлённых свечей рассчитываются признаки, используемые моделью для прогноза.
3. Обученная модель прогнозирует распределние вероятностей для цены закрытия и высшей цены на текущий день.
4. В соответствии с прогнозируемым распределнием вероятностей исходов, для каждой акции выбирается оптимальный тейк профит и рассчитывается ожидаемый результат (к примеру, если цена закрытия ожидается низкой, то лучше снизить тейк профит и увеличить шансы на его срабатывание, или если цена закрытия ожидается высокой, то лучше повысить тейк профит, чтобы увеличить результат).
5. Акции сортируются по ожидаемому результату. Банк распределяется в соответствии с заданными параметрами на "лучшие" 3-7 акций и создаются ордера на их покупку.
6. В течение часа, для всех акций, по которым сработали ордера на покупку, создаются ордера на продажу по цене их тейк профита.
7. Через час после открытия сессии ордера на покупку, которые не сработали, отменяются.
8. При наступлении закрытия сессии (10-15 минут до конца), те акции, по которым не сработали ордера на продажу по уровню тейк профита, продаются по рыночной цене.

## Устройство проекта

1. **APIUserInfo.py** - получение токенов и ID счетов из переменных окружения.  
2. **dataStorage.py** - получение списка подходящих инструментов, скачивание новых свечей и сохранение в файл.  
-_**candles**_ - dict для получения списка свечей (в исходном виде) по ID инструмента.  
-_**instMetainfo**_ - dict для получения информации по инструменту (тикер, лотность, время завершения торгов..).  
-_**downloadCandles()**_ - скачать новые свечи (не более 150 дней за раз).  
-_**getInstrumentsMetainfo()**_ - скачать информацию по инструментам.  
3. **defaultParameters.py** - оптимальные метапараметры для признаков, обучения и торгов по умолчанию (не обязательно то же самое что используемые метапараметры). При активном подборе метапараметров в обучении указываются только те, которые актуальны. При нахождении других оптимальных наборов, значения в файле могут быть заменены.  
3. **featuresCreation.py** - переработка свечей в признаки; создание датасетов для обучения, теста и прогнозирования в реальном времени, создание индексов для кросс валидации.  
-_**instInfo**_ - dict для получения признаков по инструменту и номеру свечи. Для каждой свечи доступна информация только до начала дня включительно. Если исходная дневная свеча содержит информацию, доступную в коцне дня (высшая цена, объём торгов..), то эта информация помещается не в текущую, а в предыдущую обработанную свечу (чтобы снизить вероятность того в обучение попадут данные которые не должны быть доступны в тот момент времени).  
-_**createXFrame()**_ -> _**xFrame**_ - создание признаков для обучения и предикта моделей на основе признаков инструментов на данный момент времени (более сложные и гибкие и просто копии исходных)  
-_**createXYTrainDatasets()**_ -> _**dateToXFrames**_.. - датасеты с группировкой фреймов на каждую дату, для возможности тестирования стратегии торговли по дням  
-_**createKFolds()**_ -> _**folds**_ - списки пар обучение/тест содержащие даты торговых сессий для кросс валидаций  
4. **fitPredict.py** - обучение, тестирование, запуск моделей.  
5. **tradeBot.py** - загрузка данных, обновление информации по ордерам и позициям, создание и отмена ордеров на покупку и продажу. Если указано два аккаунта, то операции осуществляются для каждого аккаунта.  
-_**updatePositionsAndOrders()**_ - обновить данные по позициям и ордерам через API.  
-_**updateTradingMetainfo()**_ - раз в день обновить данные по расписанию торгов, справочной информации по инструментам.  
-_**groupInfoForTodayActions()**_ - объединить прогнозы, ордера на продажу, покупку, позиции на счёте по ID инструментов, чтобы иметь данные по каждому инструменту.  
-_**timeEvent()**_ - по текущему времени определить текущий статус и необходимые действия по каждому инструменту (в том числе если бот был выключен и запущен в произвольное время сессии). Создать и отменить нужные ордера. В конце вернуть подходящее к ситуации время ожидания.  
-_**runBot()**_ -> _**mainLoop()**_ - запускать _**timeEvent()**_, ожидать необходимое время, проверять условия на завершение выполнения.  

## Настройки параметров, обучения, работы

...

## Ссылки

При создании некоторых признаков и процедур обучения моделей были использованы идеи из книги **Advances in Financial Machine Learning. Marcos Lopez de Prado (2018)**.
